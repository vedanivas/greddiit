var w={schemaTypeError:{"zh-CN":'\u53C2\u6570 "schema" \u7684\u7C7B\u578B\u5F97\u662F "Schema"\u3002',"en-US":'param "schema" type must be "Schema".'},modelCountError:{"zh-CN":"\u94A9\u5B50\u51FD\u6570\u8BBF\u95EE\u5230\u7684 Model \u6570\u91CF\u4E3A 0 \u6216\u8005\u4E0D\u5B58\u5728\u3002","en-US":"The number of models accessed is 0 or does not exist."}};function O(l){var f;if(l in w){let c=w[l];return((f=process.env.LANG)!=null?f:"").match("CN")?c["zh-CN"]:c["en-US"]}}function C(l){if(l.constructor.name!=="Schema")throw new Error(O("schemaTypeError"));l.pre(["find","findOne"],async function(f){let c=this.model.db.models;if(Object.keys(c!=null?c:{}).length===0)throw new Error(O("modelCountError"));let m=this.model.schema;function d(e){var n;let r="";if((e==null?void 0:e.instance)==="ObjectID"){let s=e.options;((n=s==null?void 0:s.ref)==null?void 0:n.length)&&(r=s.ref)}else if(e==null?void 0:e.$embeddedSchemaType)return d(e.$embeddedSchemaType);return c[r]}function g(e,r=m){var s;let n=[];for(;e.length>0;){let h=(s=e.shift())!=null?s:"";if(r.path([...n,h].join(".")))n.push(h);else{let t=d(r.path(n.join(".")));return t?[n.join("."),...g([h,...e],t.schema)]:[h]}}return n}async function u(e,r,n=m){if(typeof r!="object"||r===null||Object.keys(r).length===0)return r;let s={},h=n.path(e.join("."));for(let[t,a]of Object.entries(r)){if(!m.path(t)){let i=[...g(t.split(".")),a].reduceRight((o,p)=>p==="$"?o:{[p]:o});[[t,a]]=Object.entries(i)}let y=t.startsWith("$")?t==="$"?e:[]:[...e,t],S=y.join("."),$=n.path(S);if(!t.startsWith("$")&&$===void 0){let i=d(h);if(i){let o=await u([],a,i.schema);if(o)return{$in:(await i.find({[t]:o},"_id")).map(b=>b._id)}}}Array.isArray(a)?Object.assign(s,{[t]:await Promise.all(a.map(async i=>await u(y,i,n)))}):typeof a=="object"&&a!==null&&Object.keys(a).length>0?Object.assign(s,{[t]:Object.fromEntries(await Promise.all(Object.entries(a).map(async([i,o])=>Object.entries(await u(y,{[i]:o},n))[0])))}):s[t]=a}return s}this._conditions=await u([],this._conditions),f()})}export{C as MongooseFindByReference};
//# sourceMappingURL=main.mjs.map